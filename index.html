<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>Pattern Predictor Game</title>
  <style>
    body {
      display: flex;
      height: 100vh;
      margin: 0;
      background-color: #f0f2f5; /* Slightly softer background */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Modern font stack */
      overflow-x: hidden;
    }

    /* Sidebar for Coins and Stake */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 110px; /* Slightly wider for new stake buttons */
      height: 100%;
      background-color: #e9ecef; /* Lighter sidebar */
      padding: 20px 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 10;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .coin-display {
      font-size: 24px; /* Larger for emoji */
      font-weight: bold;
      color: #2a2a2a;
      margin-bottom: 25px;
      background-color: #ffc107; /* Gold-ish */
      padding: 8px 15px;
      border-radius: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .coin-display span {
      margin-left: 5px;
      font-size: 20px; /* Coin count size */
    }

    .stake-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    .stake-controls label {
      font-size: 14px;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }
    .stake-input-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    .stake-input-wrapper button {
      width: 28px;
      height: 28px;
      font-size: 18px;
      font-weight: bold;
      border: 1px solid #ccc;
      background-color: #f8f9fa;
      cursor: pointer;
      color: #333;
      line-height: 1; /* For better vertical centering of text */
    }
    .stake-input-wrapper button:hover {
      background-color: #e2e6ea;
    }
    .stake-input-wrapper button:first-child {
      border-radius: 5px 0 0 5px;
    }
    .stake-input-wrapper button:last-child {
      border-radius: 0 5px 5px 0;
    }
    .stake-input-wrapper input {
      width: 40px; /* Adjusted width */
      height: 28px;
      padding: 5px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-left: none;
      border-right: none;
      border-radius: 0; /* Remove individual radius */
      text-align: center;
      box-sizing: border-box;
      -moz-appearance: textfield; /* Firefox */
    }
    .stake-input-wrapper input::-webkit-outer-spin-button,
    .stake-input-wrapper input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }


    /* Main Game Area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center; /* Center content horizontally */
      justify-content: center; /* Center content vertically for overall balance */
      margin-left: 110px; /* Offset for sidebar */
      padding: 15px; /* Overall padding */
      box-sizing: border-box;
      position: relative;
    }
    
    .game-content-wrapper { /* New wrapper to control width and centering */
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 450px; /* Max width for the central game elements */
    }

    #btnToggleConfidence {
      position: absolute;
      top: 15px;
      right: 15px;
      background-color: #28a745; /* Green */
      color: white;
      border: none;
      padding: 7px 12px;
      font-size: 13px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 5;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    #btnToggleConfidence:hover {
      background-color: #218838;
    }

    .game-info-area {
      text-align: center;
      margin-bottom: 20px; /* Increased margin */
      min-height: 65px;
      width: 100%;
    }
    #scoreDisplay, #trialsDisplay {
      font-size: 18px;
      font-weight: 600; /* Slightly bolder */
      color: #343a40; /* Darker text */
      display: block;
      margin-bottom: 4px;
    }
    #statusMessage {
      font-size: 15px;
      color: #495057;
      margin-top: 8px;
      min-height: 1.3em;
      font-style: italic;
    }


    .button-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px; /* Maintained gap */
      width: 100%; /* Fill game-content-wrapper */
      max-width: 340px; /* Slightly increased for better visuals */
      margin-bottom: 25px; /* Increased margin */
    }
    .grid-button-container {
        position: relative;
    }
    .grid-button {
      width: 100%;
      aspect-ratio: 1 / 1; /* Make buttons square */
      padding: 0; /* Remove padding, rely on flex for centering text */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px; /* Slightly larger font in buttons */
      font-weight: bold;
      border: none;
      border-radius: 8px; /* More rounded */
      cursor: pointer;
      background-color: #ff7675; /* F color - light red */
      color: white;
      transition: background-color 0.2s, transform 0.1s;
      box-sizing: border-box;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .grid-button:active {
        transform: scale(0.95);
    }
    .grid-button.t {
      background-color: #55efc4; /* T color - light green/teal */
      color: #2d3436; /* Darker text on light green */
    }
    .confidence-text {
      position: absolute;
      bottom: 3px;
      right: 5px;
      font-size: 10px;
      color: #2d3436;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 1px 4px;
      border-radius: 3px;
      pointer-events: none;
    }


    /* Action Buttons Footer */
    .footer {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px; /* Increased gap */
      width: 100%;
      max-width: 380px; /* Consistent with grid max-width */
    }
    .action-button {
      padding: 12px 15px;
      font-size: 15px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .action-button:active {
        transform: translateY(1px);
    }
    .action-button:disabled {
      background-color: #adb5bd !important;
      color: #f8f9fa !important;
      cursor: not-allowed;
      box-shadow: none;
    }

    #btnScore { background-color: #28a745; color: white; } /* Green */
    #btnAnswer { background-color: #ffc107; color: #212529; } /* Amber */
    #btnDouble { background-color: #007bff; color: white; } /* Blue */
    #btnRestart { background-color: #dc3545; color: white; } /* Red */
    #btnHowTo {
      background-color: #6c757d; /* Grey */
      color: white;
      grid-column: span 2;
    }


    /* Modal Styling */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.65); z-index: 1000;
    }
    .modal-content {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background-color: #fff; padding: 30px; border-radius: 12px;
      width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      max-height: 85vh; overflow-y: auto;
    }
    .close-button {
      position: absolute; top: 15px; right: 20px; font-size: 30px;
      cursor: pointer; color: #6c757d; background: none; border: none;
    }
    .modal-content h3 { margin-top: 0; color: #343a40; font-size: 22px; margin-bottom: 15px;}
    .modal-content p { font-size: 16px; line-height: 1.6; color: #495057; }
    .modal-content ul { padding-left: 20px; margin-bottom: 0;}
    .modal-content li { margin: 12px 0; font-size: 16px; color: #495057;}

    /* Responsive Adjustments */
    @media (max-width: 768px) { /* Wider breakpoint for sidebar adjustments */
        .sidebar { width: 90px; padding: 15px 5px;}
        .main { margin-left: 90px; }
        .coin-display { padding: 6px 10px; font-size: 20px; }
        .coin-display span { font-size: 18px; }
        .stake-controls label { font-size: 13px; }
        .stake-input-wrapper button { width: 24px; height: 24px; font-size: 16px;}
        .stake-input-wrapper input { width: 36px; height: 24px; font-size: 14px;}
    }

    @media (max-width: 500px) {
      .main { padding: 10px; }
      #btnToggleConfidence { font-size: 12px; padding: 6px 10px; top:10px; right:10px;}
      .game-info-area { margin-bottom: 15px; min-height: 60px; }
      #scoreDisplay, #trialsDisplay { font-size: 16px; }
      #statusMessage { font-size: 14px;}

      .button-grid { max-width: 300px; gap: 6px; } /* Grid itself smaller */
      .grid-button { font-size: 18px; border-radius: 6px; }
      .confidence-text { font-size: 9px; }
      .footer { max-width: 300px; gap: 10px; }
      .action-button { font-size: 14px; padding: 10px 12px; border-radius: 5px;}
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="coin-display">ðŸª™<span id="coins">100</span></div>
    <div class="stake-controls">
      <label for="stake">Challenge</label>
      <div class="stake-input-wrapper">
        <button id="decrementStake" aria-label="Decrement stake">-</button>
        <input type="number" id="stake" value="10" min="1" step="1">
        <button id="incrementStake" aria-label="Increment stake">+</button>
      </div>
    </div>
  </div>

  <div class="main">
    <button id="btnToggleConfidence">Confidence %</button>
    <div class="game-content-wrapper">
      <div class="game-info-area">
        <span id="scoreDisplay">Score: ? / 16</span>
        <span id="trialsDisplay">Trials: 0 / 9</span>
        <div id="statusMessage">New game started!</div>
      </div>

      <div id="gridDiv" class="button-grid"></div>

      <div class="footer">
        <button id="btnScore" class="action-button">Check Score</button>
        <button id="btnAnswer" class="action-button">Reveal Pattern</button>
        <button id="btnDouble" class="action-button" disabled>X2</button>
        <button id="btnRestart" class="action-button">Restart</button>
        <button id="btnHowTo" class="action-button">How to Play</button>
      </div>
    </div>
     <div id="statusMessage"><br><br>By E5</div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="hideModal()" aria-label="Close modal">Ã—</button>
      <h3>How to Play</h3>
      <p>Match the hidden pattern of 'T's and 'F's in the 4x4 grid!</p>
      <ul>
        <li>Tap a button to switch its state between 'T' (True) and 'F' (False).</li>
        <li>"Check Score" shows how many of your guesses match the hidden pattern. You have a maximum of <span id="max-actions-info">9</span> tries per game. Your score and trials taken will appear at the top of the game area.</li>
        <li>Get a perfect score (16) to win double your Challenge Coins.</li>
        <li>Lose your Challenge Coins if you fail to get a perfect score within the allowed tries.</li>
        <li>Use "X2" after a loss to double your next challenge amount (up to your current coin balance).</li>
        <li><strong>Confidence %:</strong> Tap the "Confidence %" button (top-right) to see the AI's prediction for each square. The percentage indicates the AI's belief that a square is 'T'. This updates as you play and provide more data (by checking scores). This is just a hint!</li>
        <li>"Reveal Pattern" will show you the answer but ends the current game (and you lose the coins).</li>
      </ul>
    </div>
  </div>
 

  <script>
    const N = 16;
    const MAX_ACTIONS = 9;

    let actions = 0;
    let patT = Array(N).fill(0);
    let patG = Array(N).fill(0);
    let currentScore = 0;
    let coins = Math.floor(Math.random() * 101) + 50;

    const gridDiv = document.getElementById('gridDiv');
    const stakeInput = document.getElementById('stake');
    const coinsDisplay = document.getElementById('coins');
    const scoreDisplayElement = document.getElementById('scoreDisplay');
    const trialsDisplayElement = document.getElementById('trialsDisplay');
    const statusMessageElement = document.getElementById('statusMessage');
    const maxActionsInfoDisplay = document.getElementById('max-actions-info');
    const decrementStakeBtn = document.getElementById('decrementStake');
    const incrementStakeBtn = document.getElementById('incrementStake');

    const btns = [];
    const confidenceSpans = [];

    let predictorConfidences = new Array(N).fill(0.5);
    let sumScoresIfBitWasT = new Array(N).fill(0);
    let countIfBitWasT = new Array(N).fill(0);
    let sumScoresIfBitWasF = new Array(N).fill(0);
    let countIfBitWasF = new Array(N).fill(0);
    const predictorSmoothingFactor = 2; 
    const predictorPriorAverageScore = N / 2; 
    let showConfidence = false;

    function initGrid() {
      for (let i = 0; i < N; i++) {
        const container = document.createElement('div');
        container.className = 'grid-button-container';
        const btn = document.createElement('button');
        btn.className = 'grid-button';
        btn.innerHTML = 'F';
        btn.onclick = () => toggleButton(i);
        const confSpan = document.createElement('span');
        confSpan.className = 'confidence-text';
        confSpan.style.display = 'none';
        btns.push(btn);
        confidenceSpans.push(confSpan);
        container.appendChild(btn);
        container.appendChild(confSpan);
        gridDiv.appendChild(container);
      }
    }

    function toggleButton(i) {
      if (actions < MAX_ACTIONS && !btns[i].disabled) {
        patG[i] = 1 - patG[i];
        btns[i].innerHTML = patG[i] ? 'T' : 'F';
        btns[i].className = 'grid-button' + (patG[i] ? ' t' : '');
      }
    }

    function generatePattern() {
      let sumT;
      do {
        sumT = 0;
        for (let i = 0; i < N; i++) {
          patT[i] = Math.random() > 0.5 ? 1 : 0;
          if (patT[i] === 1) sumT++;
        }
      } while (sumT === 0 || sumT === N || patT.every((val, idx) => val === patG[idx]));
    }

    function calculateCurrentScoreValue() {
      currentScore = 0;
      for (let i = 0; i < N; i++) {
        if (patG[i] === patT[i]) currentScore++;
      }
    }

    function updatePredictor(currentGuess, scoreVal) {
      for (let i = 0; i < N; i++) {
        if (currentGuess[i] === 1) {
          sumScoresIfBitWasT[i] += scoreVal;
          countIfBitWasT[i]++;
        } else {
          sumScoresIfBitWasF[i] += scoreVal;
          countIfBitWasF[i]++;
        }
        let smoothed_avgS_T = (sumScoresIfBitWasT[i] + predictorPriorAverageScore * predictorSmoothingFactor) / (countIfBitWasT[i] + predictorSmoothingFactor);
        let smoothed_avgS_F = (sumScoresIfBitWasF[i] + predictorPriorAverageScore * predictorSmoothingFactor) / (countIfBitWasF[i] + predictorSmoothingFactor);
        let denominator = smoothed_avgS_T + smoothed_avgS_F + 0.00001;
        predictorConfidences[i] = (denominator === 0.00001 && smoothed_avgS_T === 0) ? 0.5 : smoothed_avgS_T / denominator;
        predictorConfidences[i] = Math.max(0.01, Math.min(0.99, predictorConfidences[i]));
      }
      if (showConfidence) displayConfidences();
    }

    function displayConfidences() {
      confidenceSpans.forEach((span, i) => {
        span.innerHTML = `${(predictorConfidences[i] * 100).toFixed(0)}%`;
        span.style.display = 'block';
      });
    }

    function hideConfidences() {
      confidenceSpans.forEach(span => span.style.display = 'none');
    }

    function toggleConfidenceDisplay() {
      showConfidence = !showConfidence;
      if (showConfidence) displayConfidences(); else hideConfidences();
    }
    document.getElementById('btnToggleConfidence').onclick = toggleConfidenceDisplay;

    function handleScoreCheck() {
      if (actions < MAX_ACTIONS) {
        calculateCurrentScoreValue();
        actions++;
        scoreDisplayElement.textContent = `Score: ${currentScore} / ${N}`;
        trialsDisplayElement.textContent = `Trials: ${actions} / ${MAX_ACTIONS}`;
        statusMessageElement.textContent = `Checked score: ${currentScore}/${N}.`;
        updatePredictor([...patG], currentScore);
        if (currentScore === N) endGame(true);
        else if (actions >= MAX_ACTIONS) endGame(false);
      }
    }

    function revealAnswer() {
      patG = [...patT]; // Make guess match the pattern
      btns.forEach((btn, i) => {
        btn.innerHTML = patT[i] ? 'T' : 'F';
        btn.className = 'grid-button' + (patT[i] ? ' t' : '');
      });
      calculateCurrentScoreValue(); 
      endGame(false, true);
    }

    function doubleStake() {
      let currentStake = parseInt(stakeInput.value) || 1;
      let maxPossibleStake = coins > 0 ? coins : 1;
      let newStake = Math.min(currentStake * 2, maxPossibleStake);
      stakeInput.value = newStake;
      updateStakeButtonStates();
      document.getElementById('btnDouble').disabled = true;
      statusMessageElement.textContent = `Next stake doubled to ${newStake}.`;
    }

    function endGame(isWin, revealed = false) {
      calculateCurrentScoreValue();
      scoreDisplayElement.textContent = `Final Score: ${currentScore} / ${N}`;
      trialsDisplayElement.textContent = `Trials: ${actions} / ${MAX_ACTIONS}`;
      let stake = parseInt(stakeInput.value) || 1;
      let message = "";
      if (isWin) {
        coins += stake * 2;
        message = `Perfect! You won ${stake*2} coins!`;
      } else {
        coins -= stake;
        message = revealed ? `Pattern revealed. Lost ${stake} coins.` : `Game Over! Lost ${stake} coins.`;
      }
      coins = Math.max(0, coins);
      coinsDisplay.textContent = coins;
      statusMessageElement.textContent = message;
      btns.forEach(btn => btn.disabled = true);
      document.getElementById('btnScore').disabled = true;
      document.getElementById('btnAnswer').disabled = true;
      if (coins > 0) {
        document.getElementById('btnDouble').disabled = false;
        stakeInput.disabled = false;
        if (parseInt(stakeInput.value) > coins) stakeInput.value = coins;
        if (parseInt(stakeInput.value) < 1 && coins > 0) stakeInput.value = 1;
      } else {
        document.getElementById('btnDouble').disabled = true;
        stakeInput.value = 0;
        stakeInput.disabled = true;
        statusMessageElement.textContent += " You're out of coins!";
      }
      updateStakeButtonStates();
    }

    function restart() {
      actions = 0;
      scoreDisplayElement.textContent = `Score: ? / ${N}`;
      trialsDisplayElement.textContent = `Trials: 0 / ${MAX_ACTIONS}`;
      statusMessageElement.innerHTML = 'Â ';
      patG.fill(0);
      generatePattern();
      predictorConfidences.fill(0.5);
      sumScoresIfBitWasT.fill(0); countIfBitWasT.fill(0);
      sumScoresIfBitWasF.fill(0); countIfBitWasF.fill(0);
      if (showConfidence) displayConfidences(); else hideConfidences();
      btns.forEach(btn => {
        btn.innerHTML = 'F';
        btn.className = 'grid-button';
        btn.disabled = false;
      });
      document.getElementById('btnScore').disabled = false;
      document.getElementById('btnAnswer').disabled = false;
      document.getElementById('btnDouble').disabled = true;
      if (coins === 0) {
        stakeInput.value = 0;
        stakeInput.disabled = true;
        document.getElementById('btnScore').disabled = true;
        statusMessageElement.textContent = "Restarted. You have no coins to play.";
      } else {
        stakeInput.disabled = false;
        let currentStakeVal = parseInt(stakeInput.value);
        if (isNaN(currentStakeVal) || currentStakeVal > coins || currentStakeVal < 1) {
          stakeInput.value = Math.max(1, Math.min(coins, 10));
        }
        statusMessageElement.textContent = "New game started!";
      }
      updateStakeButtonStates();
    }

    function showModal() { document.getElementById('modal').style.display = 'block'; }
    function hideModal() { document.getElementById('modal').style.display = 'none'; }

    function updateStakeValue(change) {
        let currentValue = parseInt(stakeInput.value) || 0;
        let newValue = currentValue + change;
        if (coins === 0) {
            stakeInput.value = 0;
        } else {
            stakeInput.value = Math.max(1, Math.min(newValue, coins));
        }
        updateStakeButtonStates();
    }

    function updateStakeButtonStates() {
        const val = parseInt(stakeInput.value);
        decrementStakeBtn.disabled = val <= 1 || coins === 0 || stakeInput.disabled;
        incrementStakeBtn.disabled = val >= coins || coins === 0 || stakeInput.disabled;
    }

    stakeInput.addEventListener('input', function() {
      let value = parseInt(this.value);
      if (isNaN(value)) {
        this.value = (coins > 0) ? 1 : 0;
      } else if (coins === 0) {
        this.value = 0;
      } else {
        this.value = Math.max(1, Math.min(value, coins));
      }
      updateStakeButtonStates();
    });

    decrementStakeBtn.onclick = () => updateStakeValue(-1);
    incrementStakeBtn.onclick = () => updateStakeValue(1);

    document.getElementById('btnScore').onclick = handleScoreCheck;
    document.getElementById('btnAnswer').onclick = revealAnswer;
    document.getElementById('btnDouble').onclick = doubleStake;
    document.getElementById('btnRestart').onclick = restart;
    document.getElementById('btnHowTo').onclick = showModal;

    initGrid();
    coinsDisplay.textContent = coins;
    maxActionsInfoDisplay.innerHTML = MAX_ACTIONS;
    restart();
  </script>
</body>
</html>